# 系统监控
很多系统中都有守护进程，它们能在后台监控系统的运行状态，在出现意外情况时及时响应。系统监控是 Go 语言运行时的重要组成部分，它会每隔一段时间检查 Go 语言运行时，确保程序没有进入异常状态。然后我们会学习 Go 语言监控系统的设计与实现原理，包括它的启动、执行过程，以及主要职责。

## 设计原理

在支持多任务的操作系统中，守护进程（Daemon）是后台运行的计算机程序。守护进程不会由用户直接操作，它一般会在操作系统启动时自动启动， Kubernetes 的 DaemonSet 和 Go 语言的监控系统都使用类似设计提供一些通用的功能：

[go语言系统监控](https://img.draveness.me/2020-02-15-15817706777634-golang-system-monitor.png)

守护进程是很有效的设计，它在整个系统的生命周期中都会存在，会随着系统的启动而启动，系统的结束而结束。在操作系统中，我们通常会将数据库服务、日志服务、以及监控服务等进程作为守护进程启动。

Go语言的系统监控也起到了很重要的作用，它在内部启动了一个不会中止的循环，在循环的内部会轮询网络、抢占长期运行或者处于系统调用的Goroutine以及触发垃圾回收，通过这些行为，它能够让系统的运行状态变得健康。

## 监控循环

当 Go 语言程序启动时，运行时会在第一个 Goroutine 中调用 runtime.main 启动程序， 该函数会在系统栈中创建新的线程：

```
func main() {
    ...
    if GOARCH != "wasm" {
        systemstack(func() {
            newm(sysmon, nil)
        })
    }
}
```

[runtime.newm](https://github.com/golang/go/blob/64c22b70bf00e15615bb17c29f808b55bc339682/src/runtime/proc.go#L1703) 会创建一个存储待执行函数和处理器的新结构体 runtime.m。运行时执行系统监控不需要处理器，系统监控的 Goroutine 会直接在创建的线程上运行：